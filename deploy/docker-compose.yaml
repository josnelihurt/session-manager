services:
  # Session Manager API
  session-manager-api:
    image: ghcr.io/josnelihurt/session-manager-api:latest
    container_name: session-manager-api
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - session-manager-internal
      - database-internal
      - public-wan
    environment:
      - TZ=${TZ}
      # Redis
      - Redis__ConnectionString=${Redis__ConnectionString}
      - Redis__SessionKeyPattern=${Redis__SessionKeyPattern}
      # Database
      - Database__ConnectionString=${Database__ConnectionString}
      # Auth
      - Auth__JwtSecret=${Auth__JwtSecret}
      - Auth__JwtIssuer=${Auth__JwtIssuer}
      - Auth__JwtAudience=${Auth__JwtAudience}
      - Auth__SessionLifetimeHours=${Auth__SessionLifetimeHours}
      - Auth__CookieDomain=${Auth__CookieDomain}
      - Auth__CookieName=${Auth__CookieName}
      # Google OAuth
      - Google__ClientId=${Google__ClientId}
      - Google__ClientSecret=${Google__ClientSecret}
      - Google__RedirectUri=${Google__RedirectUri}
      # CORS
      - Cors__FrontendUrl=${Cors__FrontendUrl}
      # Allowed Applications
      - AllowedApplications=${AllowedApplications}
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=public-wan"
      # API routes
      - "traefik.http.routers.session-manager-api.entrypoints=https"
      - "traefik.http.routers.session-manager-api.rule=Host(`session-manager.lab.josnelihurt.me`) && PathPrefix(`/api`)"
      - "traefik.http.routers.session-manager-api.priority=100"
      - "traefik.http.routers.session-manager-api.tls=true"
      - "traefik.http.routers.session-manager-api.tls.certresolver=cloudflare"
      - "traefik.http.routers.session-manager-api.service=session-manager-api"
      # Auth routes (ForwardAuth)
      - "traefik.http.routers.session-manager-auth.entrypoints=https"
      - "traefik.http.routers.session-manager-auth.rule=Host(`session-manager.lab.josnelihurt.me`) && PathPrefix(`/auth`)"
      - "traefik.http.routers.session-manager-auth.priority=100"
      - "traefik.http.routers.session-manager-auth.tls=true"
      - "traefik.http.routers.session-manager-auth.tls.certresolver=cloudflare"
      - "traefik.http.routers.session-manager-auth.service=session-manager-api"
      # Service port
      - "traefik.http.services.session-manager-api.loadbalancer.server.port=8080"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Session Manager Frontend
  session-manager-frontend:
    image: ghcr.io/josnelihurt/session-manager-frontend:latest
    container_name: session-manager-frontend
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - session-manager-internal
      - public-wan
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=public-wan"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.session-manager.entrypoints=http"
      - "traefik.http.routers.session-manager.rule=Host(`session-manager.lab.josnelihurt.me`)"
      - "traefik.http.routers.session-manager.middlewares=session-manager-https-redirect"
      # HTTPS router
      - "traefik.http.routers.session-manager-secure.entrypoints=https"
      - "traefik.http.routers.session-manager-secure.rule=Host(`session-manager.lab.josnelihurt.me`)"
      - "traefik.http.routers.session-manager-secure.tls=true"
      - "traefik.http.routers.session-manager-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.session-manager-secure.service=session-manager-frontend"
      - "traefik.http.services.session-manager-frontend.loadbalancer.server.port=80"
      # Middleware
      - "traefik.http.middlewares.session-manager-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.session-manager-https-redirect.redirectscheme.permanent=true"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  session-manager-internal:
    external: true
    name: session-manager-internal
  database-internal:
    external: true
    name: database-internal
  public-wan:
    external: true
    name: public-wan
