name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_API: ghcr.io/${{ github.repository }}-api
  IMAGE_FRONTEND: ghcr.io/${{ github.repository }}-frontend
  SSH_HOST: vultur.josnelihurt.me
  SSH_USER: jrb

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to vultur server
        run: |
          ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e

            # Stop existing containers
            echo "Stopping existing containers..."
            docker stop session-manager-api session-manager-frontend 2>/dev/null || true
            docker rm session-manager-api session-manager-frontend 2>/dev/null || true

            # Pull new images
            echo "Pulling new images..."
            docker pull ${{ env.IMAGE_API }}:latest
            docker pull ${{ env.IMAGE_FRONTEND }}:latest

            # Start API container
            echo "Starting API container..."
            docker run -d \
              --name session-manager-api \
              --restart unless-stopped \
              --network session-manager-internal \
              --network database-internal \
              --network public-wan \
              --env-file /opt/docker_data/session-manager/.env \
              -l traefik.enable=true \
              -l traefik.docker.network=public-wan \
              -l "traefik.http.routers.session-manager-api.entrypoints=https" \
              -l "traefik.http.routers.session-manager-api.rule=Host(\`session-manager.lab.josnelihurt.me\`) && PathPrefix(\`/api\`)" \
              -l "traefik.http.routers.session-manager-api.priority=100" \
              -l "traefik.http.routers.session-manager-api.tls=true" \
              -l "traefik.http.routers.session-manager-api.tls.certresolver=cloudflare" \
              -l "traefik.http.routers.session-manager-api.service=session-manager-api" \
              -l "traefik.http.services.session-manager-api.loadbalancer.server.port=8080" \
              -l "traefik.http.routers.session-manager-auth.entrypoints=https" \
              -l "traefik.http.routers.session-manager-auth.rule=Host(\`session-manager.lab.josnelihurt.me\`) && PathPrefix(\`/auth\`)" \
              -l "traefik.http.routers.session-manager-auth.priority=100" \
              -l "traefik.http.routers.session-manager-auth.tls=true" \
              -l "traefik.http.routers.session-manager-auth.tls.certresolver=cloudflare" \
              -l "traefik.http.routers.session-manager-auth.service=session-manager-api" \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              ${{ env.IMAGE_API }}:latest

            # Start Frontend container
            echo "Starting Frontend container..."
            docker run -d \
              --name session-manager-frontend \
              --restart unless-stopped \
              --network session-manager-internal \
              --network public-wan \
              -l traefik.enable=true \
              -l traefik.docker.network=public-wan \
              -l "traefik.http.routers.session-manager.entrypoints=http" \
              -l "traefik.http.routers.session-manager.rule=Host(\`session-manager.lab.josnelihurt.me\`)" \
              -l "traefik.http.routers.session-manager.middlewares=session-manager-https-redirect" \
              -l "traefik.http.routers.session-manager-secure.entrypoints=https" \
              -l "traefik.http.routers.session-manager-secure.rule=Host(\`session-manager.lab.josnelihurt.me\`)" \
              -l "traefik.http.routers.session-manager-secure.tls=true" \
              -l "traefik.http.routers.session-manager-secure.tls.certresolver=cloudflare" \
              -l "traefik.http.routers.session-manager-secure.service=session-manager-frontend" \
              -l "traefik.http.services.session-manager-frontend.loadbalancer.server.port=80" \
              -l "traefik.http.middlewares.session-manager-https-redirect.redirectscheme.scheme=https" \
              -l "traefik.http.middlewares.session-manager-https-redirect.redirectscheme.permanent=true" \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              ${{ env.IMAGE_FRONTEND }}:latest

            # Verify containers are running
            echo "Verifying containers..."
            sleep 5
            docker ps | grep session-manager

            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -af --filter "until=24h"

            echo "Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          # Check if containers are accessible
          curl -f -s -o /dev/null -w "%{http_code}" https://session-manager.lab.josnelihurt.me/ || echo "Frontend check failed"
          curl -f -s -o /dev/null -w "%{http_code}" https://session-manager.lab.josnelihurt.me/api/health || echo "API check failed"
          echo "Deployment verification complete"
